module.exports=[63021,(a,b,c)=>{b.exports=a.x("@prisma/client-2c3a283f134fdcb6",()=>require("@prisma/client-2c3a283f134fdcb6"))},37936,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"registerServerReference",{enumerable:!0,get:function(){return d.registerServerReference}});let d=a.r(11857)},13095,(a,b,c)=>{"use strict";function d(a){for(let b=0;b<a.length;b++){let c=a[b];if("function"!=typeof c)throw Object.defineProperty(Error(`A "use server" file can only export async functions, found ${typeof c}.
Read more: https://nextjs.org/docs/messages/invalid-use-server-value`),"__NEXT_ERROR_CODE",{value:"E352",enumerable:!1,configurable:!0})}}Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"ensureServerEntryExports",{enumerable:!0,get:function(){return d}})},90515,a=>{"use strict";var b=a.i(37936),c=a.i(31191),d=a.i(18558),e=a.i(5246),f=a.i(13095);let g=new Map;async function h(a,b,f){try{let h=(await (0,e.headers)()).get("x-forwarded-for")||"unknown";if("unknown"!==h){let a=g.get(h);if(a&&Date.now()-a<6e4)return{success:!1,error:"Too many requests. Please wait."};g.set(h,Date.now())}let i=await (0,e.cookies)(),j=i.get("last_ticket_time");if(j&&Date.now()-parseInt(j.value)<6e4)return{success:!1,error:"Veuillez patienter avant de prendre un nouveau ticket."};let k=await c.prisma.clinic.findUnique({where:{slug:a}});if(!k)throw Error("Clinic not found");let l=await c.prisma.$transaction(async a=>{await a.$executeRaw`SELECT * FROM Clinic WHERE id = ${k.id} FOR UPDATE`;let c=await a.clinic.findUnique({where:{id:k.id}});if(!c)throw Error("Clinic lost");let d=new Date;d.setHours(0,0,0,0);let e=c.dailyTicketCount;new Date(c.lastTicketDate)<d?e=1:e++,await a.clinic.update({where:{id:k.id},data:{dailyTicketCount:e,lastTicketDate:new Date}});let g=`A${e.toString().padStart(2,"0")}`,h=await a.turn.findFirst({where:{clinicId:k.id,status:{in:["WAITING","URGENT","DELAYED","ACTIVE"]}},orderBy:{position:"desc"}}),i=h?h.position+1:1,j="WAITING";if(f)try{let a="string"==typeof f?JSON.parse(f):f,b=a=>a.trim().toLowerCase(),c=Object.entries(a).find(([a])=>"urgent"===b(a)||b(a).includes("urgence"));c&&("yes"===String(c[1]).toLowerCase()||"oui"===String(c[1]).toLowerCase())&&(j="URGENT")}catch(a){}return await a.turn.create({data:{clinicId:k.id,ticketCode:g,position:i,status:j,patientName:b,answers:f?JSON.stringify(f):void 0}})});return(0,d.revalidatePath)(`/p/${a}`),i.set("last_ticket_time",Date.now().toString(),{secure:!0,httpOnly:!0}),{success:!0,turn:l}}catch(a){return console.error("CreateTurn Error:",a),{success:!1,error:"An error occurred while creating your ticket."}}}async function i(a){try{let b=await c.prisma.turn.findUnique({where:{id:a},include:{clinic:{select:{avgTime:!0,slug:!0,name:!0}}}});if(!b)return{success:!1,error:"Turn not found"};let d=await c.prisma.turn.count({where:{clinicId:b.clinicId,status:{in:["WAITING","URGENT","ACTIVE"]},position:{lt:b.position}}});return{success:!0,turn:b,peopleAhead:d,estimatedTime:d*b.clinic.avgTime}}catch(a){return{success:!1,error:"Failed to fetch status"}}}(0,f.ensureServerEntryExports)([h,i]),(0,b.registerServerReference)(h,"7060889634000bdcd1443d814fa982ef01a06e05e1",null),(0,b.registerServerReference)(i,"40625cfbdc550bbe4f8855363b94e3aa4a94a0bbb4",null),a.s([],62906),a.i(62906),a.s(["40625cfbdc550bbe4f8855363b94e3aa4a94a0bbb4",()=>i,"7060889634000bdcd1443d814fa982ef01a06e05e1",()=>h],90515)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__0a1939d5._.js.map